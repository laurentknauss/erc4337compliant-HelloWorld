{"version":3,"file":"signer.js","sourceRoot":"","sources":["../../../../../../src/msca/plugins/session-key/signer.ts"],"names":[],"mappings":"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","sourcesContent":["import { LocalAccountSigner, type SmartAccountSigner } from \"@aa-sdk/core\";\nimport type {\n  Hex,\n  PrivateKeyAccount,\n  SignableMessage,\n  TypedData,\n  TypedDataDefinition,\n} from \"viem\";\nimport { generatePrivateKey } from \"viem/accounts\";\nimport { z } from \"zod\";\n\nexport const SessionKeySignerSchema = z.object({\n  storageType: z\n    .union([z.literal(\"local-storage\"), z.literal(\"session-storage\")])\n    .or(z.custom<Storage>())\n    .default(\"local-storage\"),\n  storageKey: z.string().default(\"session-key-signer:session-key\"),\n});\n\nexport type SessionKeySignerConfig = z.input<typeof SessionKeySignerSchema>;\nexport const SESSION_KEY_SIGNER_TYPE_PFX = \"alchemy:session-key\";\n\n/**\n * A simple session key signer that uses localStorage or sessionStorage to store\n * a private key. If the key is not found, it will generate a new one and store\n * it in the storage.\n */\nexport class SessionKeySigner\n  implements SmartAccountSigner<LocalAccountSigner<PrivateKeyAccount>>\n{\n  signerType: string;\n  inner: LocalAccountSigner<PrivateKeyAccount>;\n  private storageType: \"local-storage\" | \"session-storage\" | Storage;\n  private storageKey: string;\n\n  /**\n   * Initializes a new instance of a session key signer with the provided configuration. This will set the `signerType`, `storageKey`, and `storageType`. It will also manage the session key, either fetching it from storage or generating a new one if it doesn't exist.\n   *\n   * @example\n   * ```ts\n   * import { SessionKeySigner } from \"@account-kit/smart-contracts\";\n   *\n   * const signer = new SessionKeySigner();\n   * ```\n   *\n   * @param {SessionKeySignerConfig} config_ the configuration for initializing the session key signer\n   */\n  constructor(config_: SessionKeySignerConfig = {}) {\n    const config = SessionKeySignerSchema.parse(config_);\n    this.signerType = `${SESSION_KEY_SIGNER_TYPE_PFX}`;\n    this.storageKey = config.storageKey;\n    this.storageType = config.storageType;\n\n    const sessionKey = (() => {\n      const storage =\n        typeof this.storageType !== \"string\"\n          ? this.storageType\n          : this.storageType === \"session-storage\"\n          ? sessionStorage\n          : localStorage;\n      const key = storage.getItem(this.storageKey);\n\n      if (key) {\n        return key;\n      } else {\n        const newKey = generatePrivateKey();\n        storage.setItem(this.storageKey, newKey);\n        return newKey;\n      }\n    })() as Hex;\n\n    this.inner = LocalAccountSigner.privateKeyToAccountSigner(sessionKey);\n  }\n\n  /**\n   * An async function that retrieves the address using the inner object's `getAddress` method.\n   *\n   * @example\n   * ```ts\n   * import { SessionKeySigner } from \"@account-kit/smart-contracts\";\n   *\n   * const signer = new SessionKeySigner();\n   * const sessionKeyAddress = await signer.getAddress();\n   * ```\n   *\n   * @returns {Promise<string>} A promise that resolves to the address as a string\n   */\n  getAddress: () => Promise<`0x${string}`> = async () => {\n    return this.inner.getAddress();\n  };\n\n  /**\n   * Signs a message using the inner signer.\n   *\n   * @example\n   * ```ts\n   * import { SessionKeySigner } from \"@account-kit/smart-contracts\";\n   *\n   * const signer = new SessionKeySigner();\n   * const sessionKeyAddress = await signer.signMessage(\"hello\");\n   * ```\n   *\n   * @param {SignableMessage} msg The message to sign\n   * @returns {Promise<Hex>} A promise that resolves to the signed message\n   */\n  signMessage: (msg: SignableMessage) => Promise<`0x${string}`> = async (\n    msg\n  ) => {\n    return this.inner.signMessage(msg);\n  };\n\n  /**\n   * Signs the provided typed data using the inner signer.\n   *\n   * @example\n   * ```ts\n   * import { SessionKeySigner } from \"@account-kit/smart-contracts\";\n   *\n   * const signer = new SessionKeySigner();\n   * console.log(await signer.signTypedData({\n   *  types: {\n   *    \"Message\": [{ name: \"content\", type: \"string\" }]\n   *  },\n   *  primaryType: \"Message\",\n   *  message: { content: \"Hello\" },\n   * }));\n   * ```\n   *\n   * @template TTypedData - The typed data type, which extends `TypedData` or a record of unknown keys to unknown values.\n   * @template TPrimaryType - The primary type of the typed data.\n   *\n   * @param {TypedDataDefinition<TTypedData, TPrimaryType>} params The parameters containing the typed data definition and primary type.\n   * @returns {Promise<string>} A promise that resolves to the signed typed data as a string.\n   */\n  signTypedData = async <\n    const TTypedData extends TypedData | { [key: string]: unknown },\n    TPrimaryType extends keyof TTypedData | \"EIP712Domain\" = keyof TTypedData\n  >(\n    params: TypedDataDefinition<TTypedData, TPrimaryType>\n  ) => {\n    return this.inner.signTypedData(params);\n  };\n\n  /**\n   * Generates a new private key and stores it in the storage.\n   *\n   * @example\n   * ```ts\n   * import { SessionKeySigner } from \"@account-kit/smart-contracts\";\n   *\n   * const signer = new SessionKeySigner();\n   * const newSessionKey = signer.generateNewKey();\n   * ```\n   *\n   * @returns {Address} The public address of the new key.\n   */\n  generateNewKey = () => {\n    const storage =\n      this.storageType === \"session-storage\" ? sessionStorage : localStorage;\n\n    const newKey = generatePrivateKey();\n    storage.setItem(this.storageKey, newKey);\n    this.inner = LocalAccountSigner.privateKeyToAccountSigner(newKey);\n\n    return this.inner.inner.address;\n  };\n}\n"]}