{"version":3,"file":"dropAndReplaceUserOperation.js","sourceRoot":"","sources":["../../../../src/actions/smartAccount/dropAndReplaceUserOperation.ts"],"names":[],"mappings":"AAKA,OAAO,EAAE,wBAAwB,EAAE,MAAM,sCAAsC,CAAC;AAEhF,OAAO,EAAE,oBAAoB,EAAE,MAAM,yBAAyB,CAAC;AAC/D,OAAO,EAAE,uBAAuB,EAAE,MAAM,wBAAwB,CAAC;AAMjE,OAAO,EACL,SAAS,EACT,cAAc,EACd,iBAAiB,GAClB,MAAM,sBAAsB,CAAC;AAC9B,OAAO,EAAE,mBAAmB,EAAE,MAAM,kCAAkC,CAAC;AACvE,OAAO,EAAE,kBAAkB,EAAE,MAAM,iCAAiC,CAAC;AAMrE;;;;;;;;;;;;;;;;;;;;;GAqBG;AACH,MAAM,CAAC,KAAK,UAAU,2BAA2B,CAW/C,MAA4C,EAC5C,IAA+D;IAE/D,MAAM,EAAE,OAAO,GAAG,MAAM,CAAC,OAAO,EAAE,QAAQ,EAAE,SAAS,EAAE,OAAO,EAAE,GAAG,IAAI,CAAC;IACxE,IAAI,CAAC,OAAO,EAAE,CAAC;QACb,MAAM,IAAI,oBAAoB,EAAE,CAAC;IACnC,CAAC;IACD,IAAI,CAAC,wBAAwB,CAAC,MAAM,CAAC,EAAE,CAAC;QACtC,MAAM,IAAI,uBAAuB,CAC/B,wBAAwB,EACxB,6BAA6B,EAC7B,MAAM,CACP,CAAC;IACJ,CAAC;IAED,MAAM,UAAU,GAAG,OAAO,CAAC,aAAa,EAAE,CAAC;IAE3C,MAAM,UAAU,GAAG,CACjB,UAAU,CAAC,OAAO,KAAK,OAAO;QAC5B,CAAC,CAAC;YACE,QAAQ,EAAG,QAA0C,CAAC,QAAQ;YAC9D,MAAM,EAAG,QAA0C,CAAC,MAAM;YAC1D,KAAK,EAAG,QAA0C,CAAC,KAAK;YACxD,QAAQ,EAAG,QAA0C,CAAC,QAAQ;YAC9D,SAAS,EAAE,MAAM,OAAO,CAAC,iBAAiB,EAAE;SAC7C;QACH,CAAC,CAAC;YACE,GAAG,CAAE,QAA0C,CAAC,OAAO;gBACtD,QAA0C,CAAC,WAAW;gBACrD,CAAC,CAAC;oBACE,OAAO,EAAG,QAA0C,CAAC,OAAO;oBAC5D,WAAW,EAAG,QAA0C;yBACrD,WAAW;iBACf;gBACH,CAAC,CAAC,EAAE,CAAC;YACP,MAAM,EAAG,QAA0C,CAAC,MAAM;YAC1D,KAAK,EAAG,QAA0C,CAAC,KAAK;YACxD,QAAQ,EAAG,QAA0C,CAAC,QAAQ;YAC9D,SAAS,EAAE,MAAM,OAAO,CAAC,iBAAiB,EAAE;SAC7C,CACqC,CAAC;IAE7C,4EAA4E;IAC5E,mFAAmF;IACnF,sEAAsE;IACtE,MAAM,EAAE,YAAY,EAAE,oBAAoB,EAAE,GAAG,MAAM,iBAAiB,CACpE,MAAM,MAAM,CAAC,UAAU,CAAC,YAAY,CAAC,UAAU,EAAE,EAAE,OAAO,EAAE,MAAM,EAAE,CAAC,CACtE,CAAC;IAEF,MAAM,UAAU,GAAG;QACjB,GAAG,SAAS;QACZ,YAAY,EAAE,SAAS,CACrB,MAAM,CAAC,YAAY,IAAI,EAAE,CAAC,EAC1B,cAAc,CAAC,QAAQ,CAAC,YAAY,EAAE,GAAG,CAAC,CAC3C;QACD,oBAAoB,EAAE,SAAS,CAC7B,MAAM,CAAC,oBAAoB,IAAI,EAAE,CAAC,EAClC,cAAc,CAAC,QAAQ,CAAC,oBAAoB,EAAE,GAAG,CAAC,CACnD;KAC4C,CAAC;IAEhD,MAAM,QAAQ,GAAG,MAAM,mBAAmB,CAAC,MAAM,EAAE;QACjD,EAAE,EAAE,UAAU;QACd,SAAS,EAAE,UAAU;QACrB,OAAO;KACR,CAAC,CAAC;IAEH,OAAO,kBAAkB,CAAC,MAAM,EAAE;QAChC,QAAQ,EAAE,QAAQ;QAClB,OAAO;QACP,OAAO;QACP,SAAS,EAAE,UAAU;KACtB,CAAC,CAAC;AACL,CAAC","sourcesContent":["import type { Chain, Client, Transport } from \"viem\";\nimport type {\n  GetEntryPointFromAccount,\n  SmartContractAccount,\n} from \"../../account/smartContractAccount\";\nimport { isBaseSmartAccountClient } from \"../../client/isSmartAccountClient.js\";\nimport type { SendUserOperationResult } from \"../../client/types\";\nimport { AccountNotFoundError } from \"../../errors/account.js\";\nimport { IncompatibleClientError } from \"../../errors/client.js\";\nimport type {\n  UserOperationOverrides,\n  UserOperationRequest,\n  UserOperationStruct,\n} from \"../../types\";\nimport {\n  bigIntMax,\n  bigIntMultiply,\n  resolveProperties,\n} from \"../../utils/index.js\";\nimport { _runMiddlewareStack } from \"./internal/runMiddlewareStack.js\";\nimport { _sendUserOperation } from \"./internal/sendUserOperation.js\";\nimport type {\n  DropAndReplaceUserOperationParameters,\n  UserOperationContext,\n} from \"./types\";\n\n/**\n * Drops an existing user operation and replaces it with a new one while ensuring the appropriate fees and overrides are applied.\n *\n * @example\n * ```ts\n * import {\n *  createSmartAccountClient,\n * } from \"@aa-sdk/core\";\n *\n * // smart account client is already extended with dropAndReplaceUserOperation\n * const client = createSmartAccountClient(...);\n * const { request } = await client.sendUserOperation(...);\n * const result = await client.dropAndReplaceUserOperation({\n *  uoToDrop: request,\n *  account, // only required if the client above is not connected to an account\n * });\n * ```\n *\n * @param {Client<TTransport, TChain, TAccount>} client The client instance with the transport, chain, and account information\n * @param {DropAndReplaceUserOperationParameters<TAccount, TContext>} args The parameters required for dropping and replacing the user operation including the account, operation to drop, overrides, and context\n * @returns {Promise<SendUserOperationResult<TEntryPointVersion>>} A promise that resolves to the result of sending the new user operation\n */\nexport async function dropAndReplaceUserOperation<\n  TTransport extends Transport = Transport,\n  TChain extends Chain | undefined = Chain | undefined,\n  TAccount extends SmartContractAccount | undefined =\n    | SmartContractAccount\n    | undefined,\n  TContext extends UserOperationContext | undefined =\n    | UserOperationContext\n    | undefined,\n  TEntryPointVersion extends GetEntryPointFromAccount<TAccount> = GetEntryPointFromAccount<TAccount>\n>(\n  client: Client<TTransport, TChain, TAccount>,\n  args: DropAndReplaceUserOperationParameters<TAccount, TContext>\n): Promise<SendUserOperationResult<TEntryPointVersion>> {\n  const { account = client.account, uoToDrop, overrides, context } = args;\n  if (!account) {\n    throw new AccountNotFoundError();\n  }\n  if (!isBaseSmartAccountClient(client)) {\n    throw new IncompatibleClientError(\n      \"BaseSmartAccountClient\",\n      \"dropAndReplaceUserOperation\",\n      client\n    );\n  }\n\n  const entryPoint = account.getEntryPoint();\n\n  const uoToSubmit = (\n    entryPoint.version === \"0.6.0\"\n      ? {\n          initCode: (uoToDrop as UserOperationRequest<\"0.6.0\">).initCode,\n          sender: (uoToDrop as UserOperationRequest<\"0.6.0\">).sender,\n          nonce: (uoToDrop as UserOperationRequest<\"0.6.0\">).nonce,\n          callData: (uoToDrop as UserOperationRequest<\"0.6.0\">).callData,\n          signature: await account.getDummySignature(),\n        }\n      : {\n          ...((uoToDrop as UserOperationRequest<\"0.7.0\">).factory &&\n          (uoToDrop as UserOperationRequest<\"0.7.0\">).factoryData\n            ? {\n                factory: (uoToDrop as UserOperationRequest<\"0.7.0\">).factory,\n                factoryData: (uoToDrop as UserOperationRequest<\"0.7.0\">)\n                  .factoryData,\n              }\n            : {}),\n          sender: (uoToDrop as UserOperationRequest<\"0.7.0\">).sender,\n          nonce: (uoToDrop as UserOperationRequest<\"0.7.0\">).nonce,\n          callData: (uoToDrop as UserOperationRequest<\"0.7.0\">).callData,\n          signature: await account.getDummySignature(),\n        }\n  ) as UserOperationStruct<TEntryPointVersion>;\n\n  // If the fee estimator is not the one estimating fees, then this won't work\n  // however, we have migrated to using erc7677middleware for alchemy paymaster flows\n  // and most of the other paymasters we've seen don't do fee estimation\n  const { maxFeePerGas, maxPriorityFeePerGas } = await resolveProperties(\n    await client.middleware.feeEstimator(uoToSubmit, { account, client })\n  );\n\n  const _overrides = {\n    ...overrides,\n    maxFeePerGas: bigIntMax(\n      BigInt(maxFeePerGas ?? 0n),\n      bigIntMultiply(uoToDrop.maxFeePerGas, 1.1)\n    ),\n    maxPriorityFeePerGas: bigIntMax(\n      BigInt(maxPriorityFeePerGas ?? 0n),\n      bigIntMultiply(uoToDrop.maxPriorityFeePerGas, 1.1)\n    ),\n  } as UserOperationOverrides<TEntryPointVersion>;\n\n  const uoToSend = await _runMiddlewareStack(client, {\n    uo: uoToSubmit,\n    overrides: _overrides,\n    account,\n  });\n\n  return _sendUserOperation(client, {\n    uoStruct: uoToSend,\n    account,\n    context,\n    overrides: _overrides,\n  });\n}\n"]}